@model IEnumerable<Music_player_Application.Models.MusicProperties>
@{
    bool isAjax = Context.Request.Headers["X-Requested-With"] == "XMLHttpRequest";
    if (isAjax) { Layout = null; }

    var viewType = ViewBag.ViewType ?? Context.Request.Query["viewType"].ToString() ?? "table";
    var currentLang = Context.Request.Query["lang"].ToString() ?? "en-US";
    int currentPage = int.TryParse(Context.Request.Query["page"], out var p) ? p : 1;
    bool isUk = currentLang.StartsWith("uk");

   // Hard-coded Latin labels for Ukrainian
    string hSong = isUk ? "Pisnya" : "Song";
    string hArtist = isUk ? "Vykonavets" : "Artist";
    string hAlbum = isUk ? "Albom" : "Album";
    string hGenre = isUk ? "Zhanr" : "Genre";
    string lblLyrics = isUk ? "Tekst pisni" : "Lyrics";
    string lblFrom = isUk ? "z" : "from";
    string lblBy = isUk ? "vid" : "by";
    string lblPrev = isUk ? "Nazad" : "Previous";
    string lblNext = isUk ? "Dali" : "Next";
    string lblDownload = isUk ? "Zberety" : "Save";

    int itemIndex = ((currentPage - 1) * 15) + 1;
}

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
    .chevron-icon { transition: transform 0.3s ease; }
    tr:not(.collapsed) .chevron-icon { transform: rotate(180deg); }
    .lyrics-tab { border: 1px solid #dee2e6; border-bottom: none; display: inline-block; padding: 6px 16px; border-radius: 6px 6px 0 0; background: #fff; font-weight: 600; font-size: 0.85rem; position: relative; top: 1px; }
    .stop-active { color: #dc3545 !important; }
    .full-width-music-grid { display: flex; flex-wrap: wrap; margin: 0 -10px; width: 100%; }
    .music-item { flex: 0 0 33.333%; padding: 10px; }
    .music-card:hover .play-btn-overlay { opacity: 1 !important; }
    .pagination .page-link { cursor: pointer; color: #0d6efd; background: #fff; }
    .pagination .page-item.active .page-link { background-color: #0d6efd; color: #fff; border-color: #0d6efd; }
    @@media (max-width: 992px) { .music-item { flex: 0 0 50%; } }
    @@media (max-width: 576px) { .music-item { flex: 0 0 100%; } }
</style>

@if (viewType == "gallery")
{
    if (!isAjax || currentPage == 1) { @:<div class="full-width-music-grid"> 
    }
    @foreach (var item in Model)
    {
        <div class="music-item">
            <div class="card h-100 border-0 shadow-sm music-card overflow-hidden">
                <div class="position-relative" style="height: 250px; background: #000;">
                    <img src="@item.PictureUrl" class="w-100 h-100" style="object-fit: cover; opacity: 0.8;">
                    <div class="card-img-overlay d-flex flex-column align-items-center justify-content-center opacity-0 play-btn-overlay" style="background: rgba(0,0,0,0.4); transition: 0.3s;">
                        <i class="bi bi-play-circle-fill text-white display-3 play-trigger" style="cursor:pointer" data-song-id="@item.SongId"></i>
                        <div class="progress mt-3 w-75" style="height: 6px;">
                            <div class="progress-bar bg-primary" id="seek-@item.SongId" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <h6 class="fw-bold mb-1 text-truncate">@item.song</h6>
                    <p class="text-muted small mb-0 text-truncate">@item.Artist • @item.Year</p>
                    <input type="hidden" id="lyric-@item.SongId" value="@item.Lyrics" />
                </div>
            </div>
        </div>
    }
    if (!isAjax || currentPage == 1) { @:</div> 
    }
}
else
{
    <div class="bg-white shadow-sm border rounded overflow-hidden">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th style="width:40px"></th>
                    <th style="width:60px">#</th>
                    <th>@hSong</th>
                    <th>@hArtist</th>
                    <th>@hAlbum</th>
                    <th>@hGenre</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr data-bs-toggle="collapse" data-bs-target="#details-@item.SongId" class="collapsed" style="cursor:pointer">
                        <td><i class="bi bi-chevron-down small text-muted chevron-icon"></i></td>
                        <td class="fw-bold text-primary">@(itemIndex++)</td>
                        <td class="fw-bold">@item.song</td>
                        <td>@item.Artist</td>
                        <td class="text-muted">@item.Album</td>
                        <td><span class="badge bg-light text-dark border">@item.Genre</span></td>
                    </tr>
                    <tr class="collapse" id="details-@item.SongId">
                        <td colspan="6" class="p-0">
                            <div class="p-4 bg-light border-top">
                                <div class="d-flex gap-4">
                                    <div class="text-center" style="min-width: 150px;">
                                        <img src="@item.PictureUrl" class="rounded shadow mb-3" style="width:150px; height:150px; object-fit:cover;">
                                        <div class="badge rounded-pill bg-primary w-100 py-2 mb-2">
                                            <i class="bi bi-hand-thumbs-up-fill me-1"></i> @item.Likes
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h3 class="fw-bold mb-0">@item.song</h3>
                                                <p class="text-muted">@lblFrom <strong>@item.Album</strong> @lblBy <strong>@item.Artist</strong></p>
                                                <p class="text-muted small mt-n2">@item.record, @item.Year</p>
                                            </div>
                                            <span class="badge bg-dark rounded-pill px-3 py-2">@item.duration</span>
                                        </div>

                                        <div class="bg-white p-3 rounded border my-3 d-flex align-items-center gap-3 shadow-sm">
                                            <i class="bi bi-play-circle-fill text-primary display-6 play-trigger" style="cursor:pointer" data-song-id="@item.SongId"></i>
                                            <div class="progress flex-grow-1" style="height: 10px;">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated" id="seek-@item.SongId" style="width: 0%"></div>
                                            </div>
                                           
                                            
                                        </div>

                                        <div class="lyrics-tab">@lblLyrics</div>
                                        <div class="p-3 bg-white border rounded shadow-sm" style="white-space: pre-wrap; font-size: 0.9rem;">
                                            <input type="hidden" id="lyric-@item.SongId" value="@item.Lyrics" />
                                            @item.Lyrics
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <nav class="mt-5 mb-5">
        <ul class="pagination justify-content-center shadow-sm" style="border-radius: 50px; overflow: hidden;">
            @{
                int maxPagesToShow = 5;
                int startPage = Math.Max(1, currentPage - 2);
                int endPage = startPage + maxPagesToShow - 1;
            }
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <button class="page-link border-0 px-3" onclick="changePage(@(currentPage - 1))" type="button">
                    <i class="bi bi-chevron-left"></i> @lblPrev
                </button>
            </li>
            @for (int i = startPage; i <= endPage; i++)
            {
                var pageNum = i;
                <li class="page-item @(currentPage == pageNum ? "active" : "")">
                    <button class="page-link border-0 px-3" onclick="changePage(@pageNum)" type="button">@pageNum</button>
                </li>
            }
            <li class="page-item">
                <button class="page-link border-0 px-3" onclick="changePage(@(currentPage + 1))" type="button">
                    @lblNext <i class="bi bi-chevron-right"></i>
                </button>
            </li>
        </ul>
    </nav>
}
<script>
(function () {
    const synth = window.speechSynthesis;

    // --- CHROME FIX: Improved Voice Loading ---
    let voices = [];
    const loadVoices = () => {
        voices = synth.getVoices();
        // If voices are empty (common in Chrome), try again in 100ms
        if (voices.length === 0) {
            setTimeout(loadVoices, 100);
        }
    };

    // Initialize voices immediately and on change
    loadVoices();
    if (synth.onvoiceschanged !== undefined) {
        synth.onvoiceschanged = loadVoices;
    }

    function getUkrainianVoice() {
        // Filter specifically for Ukrainian
        return voices.find(v => v.lang.startsWith('uk') || v.lang.includes('Ukrainian'));
    }

    // ---------------- SEED UTILS ----------------
    function stringToSeed(str) {
        let h = 2166136261;
        for (let i = 0; i < str.length; i++) {
            h ^= str.charCodeAt(i);
            h = Math.imul(h, 16777619);
        }
        return h >>> 0;
    }

    function hash32(seed) {
        let h = seed | 0;
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        return (h ^= h >>> 16) >>> 0;
    }

    function rnd(seed) {
        return hash32(seed) / 4294967296;
    }

    // ---------------- MUSIC ENGINE ----------------
    const MusicEngine = {
        synths: {},
        samplers: {},
        parts: [],
        melodyPattern: [],
        drumPattern: [],
        chordPattern: [],

        async init() {
            await Tone.start();
            if (this.synths.piano) return;

            this.reverb = new Tone.Reverb({ decay: 3, wet: 0.35 }).toDestination();

            this.synths.piano = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "triangle" },
                envelope: { attack: 0.03, release: 1.2 }
            }).connect(this.reverb);

            this.synths.guitar = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sawtooth" },
                envelope: { attack: 0.01, decay: 0.15, sustain: 0, release: 0.2 }
            }).connect(this.reverb);

            this.samplers.kick = new Tone.Sampler({
                urls: { "C2": "https://tonejs.github.io/audio/808/kick.mp3" }
            }).toDestination();
        },

        generatePatterns(seed, scale) {
            this.melodyPattern = Array.from({ length: 16 }, (_, i) => ({
                play: rnd(seed + i * 11) > 0.25,
                deg: Math.floor(rnd(seed + i * 17) * scale.length),
                oct: 3 + Math.floor(rnd(seed + i * 23) * 3),
                vel: rnd(seed + i * 29)
            }));

            this.drumPattern = Array.from({ length: 16 }, (_, i) => ({
                hit: rnd(seed + i * 41) > 0.5,
                vel: rnd(seed + i * 43)
            }));

            this.chordPattern = Array.from({ length: 4 }, (_, i) =>
                Math.floor(rnd(seed + i * 59) * scale.length)
            );
        },

        async start(songId) {
            await this.init();
            this.stop();

            const seed = stringToSeed(String(songId));
            const bpm = 80 + Math.floor(rnd(seed + 99) * 70);
            Tone.Transport.bpm.value = bpm;

            const scales = [[0, 2, 4, 7, 9], [0, 3, 5, 7, 10], [0, 2, 4, 5, 7, 9, 11]];
            const scale = scales[Math.floor(rnd(seed + 7) * scales.length)];
            const root = 36 + Math.floor(rnd(seed + 13) * 24);

            this.generatePatterns(seed, scale);

            const melodyLoop = new Tone.Loop(time => {
                const step = Math.floor(Tone.Transport.ticks / Tone.Time("16n").toTicks()) % 16;
                const m = this.melodyPattern[step];
                if (m.play) {
                    const note = Tone.Midi(root + scale[m.deg] + m.oct * 12).toNote();
                    this.synths.piano.triggerAttackRelease(note, "16n", time, m.vel * 0.8);
                }
            }, "16n").start(0);

            const guitarLoop = new Tone.Loop(time => {
                const step = Math.floor(Tone.Transport.ticks / Tone.Time("1n").toTicks()) % 4;
                const deg = this.chordPattern[step];
                const note = Tone.Midi(root + scale[deg] + 48).toNote();
                this.synths.guitar.triggerAttackRelease(note, "8n", time, 0.4);
            }, "1n").start(0);

            const drumLoop = new Tone.Loop(time => {
                const step = Math.floor(Tone.Transport.ticks / Tone.Time("16n").toTicks()) % 16;
                const d = this.drumPattern[step];
                if (d.hit) this.samplers.kick.triggerAttackRelease("C2", "8n", time, d.vel * 0.6);
            }, "16n").start(0);

            this.parts = [melodyLoop, guitarLoop, drumLoop];
            Tone.Transport.start();
        },

        stop() {
            Tone.Transport.stop();
            Tone.Transport.cancel();
            document.querySelectorAll('[id^="seek-"]').forEach(b => b.style.width = "0%");
            this.parts.forEach(p => p.dispose());
            this.parts = [];
        }
    };

    // ---------------- LYRICS & PROGRESS SYNC ----------------
    window.playLyricsFrom = function(startIndex) {
        synth.cancel();
        if (!window.lyricLines || !window.activeSongId) return;

        const bar = document.getElementById(`seek-${window.activeSongId}`);
        const container = bar ? bar.parentElement : null;
        let i = startIndex;
        let animFrame;

        const sing = () => {
            if (!window.activeSongId) return;

            if (i >= window.lyricLines.length) {
                stopPlayback();
                if (bar) bar.style.width = "100%";
                return;
            }

            const line = window.lyricLines[i++];
            const u = new SpeechSynthesisUtterance(line);
            
            // CHROME FIX: Selection and Fallback
            u.lang = 'uk-UA'; 
            const ukVoice = getUkrainianVoice();
            if (ukVoice) {
                u.voice = ukVoice;
            }

            const words = line.split(/\s+/).length;
            const estimatedDuration = Math.max(1500, words * 500); 
            const startTime = performance.now();

            const updateProgress = (time) => {
                if (!bar) return;
                const elapsed = time - startTime;
                const linePct = Math.min(1, elapsed / estimatedDuration);
                const overallPct = ((i - 1 + linePct) / window.lyricLines.length) * 100;
                bar.style.width = overallPct + "%";
                if (linePct < 1) animFrame = requestAnimationFrame(updateProgress);
            };

            u.onend = () => {
                cancelAnimationFrame(animFrame);
                if (window.activeSongId) setTimeout(sing, 300);
            };

            // Error listener for debugging Chrome
            u.onerror = (e) => console.error("Speech Error:", e);

            synth.speak(u);
            animFrame = requestAnimationFrame(updateProgress);
        };

        sing();

        if (container && !container.dataset.hooked) {
            container.dataset.hooked = "true";
            container.addEventListener("click", (e) => {
                e.stopPropagation();
                const rect = container.getBoundingClientRect();
                const clickPct = (e.clientX - rect.left) / rect.width;
                const targetLine = Math.floor(clickPct * window.lyricLines.length);
                
                cancelAnimationFrame(animFrame);
                window.playLyricsFrom(targetLine);
            });
        }
    };

    // ---------------- UI ----------------
    const playHandler = e => {
        const btn = e.target.closest(".play-trigger");
        if (!btn) return;

        const id = btn.getAttribute("data-song-id");

        if (window.activeSongId === id) {
            stopPlayback();
            return;
        }

        stopPlayback();
        window.activeSongId = id;
        btn.classList.replace("bi-play-circle-fill", "bi-stop-circle-fill");

        MusicEngine.start(id);

        const lyricInput = document.getElementById(`lyric-${id}`);
        if (lyricInput) {
            window.lyricLines = lyricInput.value.split("\n").filter(l => l.trim());
            window.playLyricsFrom(0);
        }
    };

    function stopPlayback() {
        synth.cancel();
        MusicEngine.stop();
        window.activeSongId = null;
        document.querySelectorAll(".play-trigger").forEach(b =>
            b.classList.replace("bi-stop-circle-fill", "bi-play-circle-fill")
        );
    }

    document.addEventListener("click", playHandler);
})();
</script>
